<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-title" content="CashWise">

    <style>
        :root {
            --bg: #F8F9FD;
            --card: #ffffff;
            --primary: #6366F1;
            --secondary: #64748B;
            --success: #22C55E;
            --danger: #EF4444;
            --note: #F59E0B;
            --text-main: #1E293B;
            --text-sub: #64748B;
            --timestamp: #64748B;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            --border: rgba(0,0,0,0.05);
        }

        * { 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; 
            padding: 0;
            width: 100vw;
            overflow-x: hidden;
        }

        .icon {
            width: 14px;
            height: 14px;
            display: inline-block;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            vertical-align: middle;
            opacity: 0.7;
        }
        .icon-wallet { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjM2NkYxIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTIwIDIxaC0xNGEyIDIgMCAwIDEtMi0ydi0xNGEyIDIgMCAwIDEgMi0yaDE2djE0YTIgMiAwIDAgMS0yIDJ6Ii8+PHBhdGggZD0iTTIyIDEwaC00YTIgMiAwIDAgMC0yIDJ2MGEyIDIgMCAwIDAgMiAyaDQiLz48L3N2Zz4='); }
        .icon-plus { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGxpbmUgeDE9IjEyIiB5MT0iNSIgeDI9IjEyIiB5Mj0iMTkiPjwvbGluZT48bGluZSB4MT0iNSIgeTE9IjEyIiB4Mj0iMTkiIHkyPSIxMiI+PC9saW5lPjwvc3ZnPg=='); width: 20px; height: 20px; opacity: 1; }
        .icon-sparkle { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjM2NkYxIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEyIDN2MW0wIDE2djFtOC05aC0xbS0xNiAwSDNtcTEzLjA1LTYuOTUgMS0xIDUuOTUgMTMuMDUgMSAxLTEzLjA1LTYuOTUgMSAxLTUuOTUgMTMuMDUgMSAxIi8+PC9zdmc+'); }
        .icon-note { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRjU5RTBCIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTExIDRINC41QTIuNSAyLjUgMCAwIDAgMiA2LjV2MTRBMi41IDIuNSAwIDAgMCA0LjUgMjNoMTRhMi41IDIuNSAwIDAgMCAyLjUtMi41VjEzIi8+PHBhdGggZD0iTTE4LjUgMi41YTIuMTIxIDIuMTIxIDAgMSAxIDMgM0wyMCAxMmwtNCAxIDEtNHoiLz48L3N2Zz4='); }

        .container {
            width: 100%;
            padding: 20px;
            padding-bottom: 120px;
        }

        .live-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 5px;
        }
        .live-time { font-weight: 800; font-size: 1.1rem; color: var(--text-main); }
        .live-date { font-weight: 600; font-size: 0.8rem; color: var(--secondary); text-transform: uppercase; }

        .tip-banner {
            background: #EEF2FF;
            border-left: 4px solid var(--primary);
            padding: 10px 14px;
            border-radius: 0 12px 12px 0;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .tip-content { font-size: 0.8rem; line-height: 1.3; color: #4338CA; font-weight: 500; }

        .summary-card {
            background: linear-gradient(135deg, #6366F1, #4F46E5);
            padding: 20px;
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-val { font-size: 2rem; font-weight: 800; }
        .download-btn {
            background: rgba(255,255,255,0.2);
            border: 1.5px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.8rem;
            backdrop-filter: blur(5px);
            font-weight: 600;
        }

        /* Group Separator */
        .day-separator {
            display: flex;
            align-items: center;
            margin: 20px 0 12px 0;
            gap: 10px;
        }
        .day-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .day-line {
            height: 1px;
            background: var(--border);
            flex-grow: 1;
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .feed-title {
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spend-item {
            background: var(--card);
            padding: 14px 16px;
            border-radius: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .item-left { display: flex; flex-direction: column; gap: 2px; max-width: 70%; }
        .item-name { font-weight: 700; font-size: 0.95rem; color: var(--text-main); white-space: pre-line; }
        .item-meta { font-size: 0.75rem; color: var(--text-sub); display: flex; align-items: center; gap: 4px; }
        .dot { font-size: 10px; opacity: 0.5; }
        
        .item-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .item-amount { font-weight: 800; color: var(--danger); font-size: 0.95rem; }
        .item-amount.is-note { color: var(--note); }
        .item-delete { color: #CBD5E1; font-size: 11px; margin-top: 4px; text-decoration: none; border: none; background: none; padding: 0; }

        /* Modal Styles */
        #add-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            display: none;
            justify-content: flex-end;
            flex-direction: column;
            z-index: 1000;
            backdrop-filter: blur(6px);
        }

        .modal-content {
            background: white;
            padding: 25px 20px;
            border-radius: 25px 25px 0 0;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            background: #F1F5F9;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .mode-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--secondary);
            border-radius: 9px;
            cursor: pointer;
            transition: 0.2s;
        }
        .mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .input-field {
            width: 100%;
            background: #F1F5F9;
            border: 2px solid transparent;
            padding: 12px 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .btn-submit {
            background: var(--primary);
            color: white;
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            transition: opacity 0.2s;
        }
        .btn-submit:active { opacity: 0.8; }

        .fab {
            position: fixed;
            bottom: 25px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
            z-index: 999;
        }

        canvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="live-status">
        <div id="live-date" class="live-date">...</div>
        <div id="live-time" class="live-time">...</div>
    </div>

    <div class="tip-banner">
        <span class="icon icon-sparkle"></span>
        <div id="financial-tip" class="tip-content">Stay financially mindful today.</div>
    </div>

    <div class="summary-card">
        <div>
            <div style="font-size: 0.85rem; opacity: 0.9;">Today's Total Spend</div>
            <div id="total-val" class="total-val">$0.00</div>
        </div>
        <button class="download-btn" onclick="downloadReport()">Save Report Image</button>
    </div>

    <div class="feed-header">
        <div class="feed-title"><span class="icon icon-wallet"></span> Activity Feed</div>
    </div>
    
    <div id="spending-list"></div>
</div>

<div class="fab" onclick="toggleModal(true)"><span class="icon icon-plus"></span></div>

<div id="add-modal" onclick="toggleModal(false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modal-title" style="margin-top:0; font-size: 1.2rem;">New Entry</h3>
        
        <div class="mode-selector">
            <button class="mode-btn active" id="mode-spend" onclick="setMode('spend')">Transaction</button>
            <button class="mode-btn" id="mode-note" onclick="setMode('note')">Notepad</button>
        </div>

        <textarea id="item-name" class="input-field" rows="3" placeholder="Description or Note..."></textarea>
        
        <div id="spend-fields">
            <input type="text" id="item-loc" class="input-field" placeholder="Store/Place">
            <div style="display:flex; gap:10px;">
                <input type="number" id="item-amount" class="input-field" placeholder="0.00" style="flex:1">
            </div>
        </div>
        
        <input type="datetime-local" id="item-time" class="input-field" style="margin-top: 10px;">
        
        <button id="main-submit" class="btn-submit" onclick="addExpense()">Add Transaction</button>
        <button onclick="toggleModal(false)" style="width:100%; background:none; border:none; color:var(--secondary); margin-top:10px; font-size:0.9rem; padding: 10px;">Close</button>
    </div>
</div>

<canvas id="export-canvas"></canvas>

<script>
    let expenses = JSON.parse(localStorage.getItem('spending_v11')) || [];
    let currentMode = 'spend';

    // CLOCK (12-hour format)
    function updateClock() {
        const now = new Date();
        document.getElementById('live-time').innerText = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        document.getElementById('live-date').innerText = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    setInterval(updateClock, 1000); updateClock();

    // FINANCIAL TIPS (every 5 mins)
    async function fetchTip() {
        const tipEl = document.getElementById('financial-tip');
        try {
            const res = await fetch('https://api.adviceslip.com/advice');
            const data = await res.json();
            tipEl.innerText = data.slip.advice;
        } catch (e) { }
    }
    setInterval(fetchTip, 300000); fetchTip();

    // RENDER LOGIC
    window.onload = () => renderExpenses();

    function format12h(dateStr) {
        const date = new Date(dateStr.replace(' ', 'T'));
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    }

    // Currency Formatter with Commas
    function formatCurrency(num) {
        return parseFloat(num).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function setMode(mode) {
        currentMode = mode;
        const spendFields = document.getElementById('spend-fields');
        const submitBtn = document.getElementById('main-submit');
        const title = document.getElementById('modal-title');
        
        document.getElementById('mode-spend').classList.toggle('active', mode === 'spend');
        document.getElementById('mode-note').classList.toggle('active', mode === 'note');

        if(mode === 'note') {
            spendFields.style.display = 'none';
            submitBtn.innerText = 'Save Note';
            submitBtn.style.background = 'var(--note)';
            title.innerText = 'New Note';
        } else {
            spendFields.style.display = 'block';
            submitBtn.innerText = 'Add Transaction';
            submitBtn.style.background = 'var(--primary)';
            title.innerText = 'New Entry';
        }
    }

    function toggleModal(show) {
        document.getElementById('add-modal').style.display = show ? 'flex' : 'none';
        if(show) {
            setMode('spend'); // Default to spend
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('item-time').value = now.toISOString().slice(0, 16);
            document.getElementById('item-name').focus();
        }
    }

    function addExpense() {
        const name = document.getElementById('item-name').value.trim();
        const time = document.getElementById('item-time').value;
        
        if (!name) return;

        if(currentMode === 'spend') {
            const loc = document.getElementById('item-loc').value || 'Store';
            const amount = document.getElementById('item-amount').value;
            if (!amount) return;

            expenses.unshift({
                id: Date.now(), type: 'spend', name, loc,
                amount: parseFloat(amount),
                time: time.replace('T', ' ')
            });
        } else {
            expenses.unshift({
                id: Date.now(), type: 'note', name,
                time: time.replace('T', ' ')
            });
        }

        saveAndRender();
        toggleModal(false);
        clearForm();
    }

    function clearForm() {
        document.getElementById('item-name').value = '';
        document.getElementById('item-loc').value = '';
        document.getElementById('item-amount').value = '';
    }

    function saveAndRender() {
        // Sort by date descending
        expenses.sort((a, b) => new Date(b.time) - new Date(a.time));
        localStorage.setItem('spending_v11', JSON.stringify(expenses));
        renderExpenses();
    }

    function renderExpenses() {
        const list = document.getElementById('spending-list');
        const totalDisp = document.getElementById('total-val');
        list.innerHTML = '';
        let total = 0;
        let lastDateLabel = "";

        expenses.forEach((item, index) => {
            // Grouping Logic
            const itemDate = new Date(item.time.replace(' ', 'T'));
            const dateLabel = itemDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            
            if (dateLabel !== lastDateLabel) {
                const sep = document.createElement('div');
                sep.className = 'day-separator';
                sep.innerHTML = `<div class="day-line"></div><div class="day-label">${dateLabel}</div><div class="day-line"></div>`;
                list.appendChild(sep);
                lastDateLabel = dateLabel;
            }

            if(item.type !== 'note') total += parseFloat(item.amount);
            
            const div = document.createElement('div');
            div.className = 'spend-item';
            
            if(item.type === 'note') {
                div.innerHTML = `
                    <div class="item-left">
                        <span class="item-name" style="color:var(--note)">${item.name}</span>
                        <div class="item-meta">
                            <span class="icon icon-note" style="opacity:1"></span>
                            <span>Note</span>
                            <span class="dot">•</span>
                            <span>${format12h(item.time)}</span>
                        </div>
                    </div>
                    <div class="item-right">
                        <div class="item-amount is-note">NOTE</div>
                        <button class="item-delete" onclick="deleteItem(${index})">Delete</button>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="item-left">
                        <span class="item-name">${item.name}</span>
                        <div class="item-meta">
                            <span>${item.loc}</span>
                            <span class="dot">•</span>
                            <span>${format12h(item.time)}</span>
                        </div>
                    </div>
                    <div class="item-right">
                        <div class="item-amount">-$${formatCurrency(item.amount)}</div>
                        <button class="item-delete" onclick="deleteItem(${index})">Delete</button>
                    </div>
                `;
            }
            list.appendChild(div);
        });
        totalDisp.innerText = `$${formatCurrency(total)}`;
    }

    function deleteItem(index) {
        expenses.splice(index, 1);
        saveAndRender();
    }

    function downloadReport() {
        const canvas = document.getElementById('export-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600;
        canvas.height = 150 + (expenses.length * 75);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#6366F1"; 
        ctx.font = "bold 26px Arial"; 
        ctx.fillText("CashWise Ledger Report", 40, 60);
        
        ctx.fillStyle = "#64748B";
        ctx.font = "14px Arial";
        ctx.fillText("Generated: " + new Date().toLocaleString(), 40, 85);

        let y = 140;
        expenses.forEach(item => {
            const isNote = item.type === 'note';
            ctx.fillStyle = isNote ? "#F59E0B" : "#1E293B"; 
            ctx.font = "bold 16px Arial"; 
            ctx.fillText(item.name.split('\n')[0].substring(0, 45), 40, y);
            
            ctx.fillStyle = "#64748B"; 
            ctx.font = "12px Arial"; 
            const sub = isNote ? "NOTE Entry" : (item.loc + "  |  " + format12h(item.time));
            ctx.fillText(sub, 40, y + 20);
            
            if(!isNote) {
                ctx.fillStyle = "#EF4444"; 
                ctx.textAlign = "right"; 
                ctx.fillText("-$" + formatCurrency(item.amount), 560, y + 10);
                ctx.textAlign = "left";
            }
            y += 70;
        });
        
        const link = document.createElement('a');
        link.download = `CashWise_Report_${Date.now()}.png`; 
        link.href = canvas.toDataURL('image/png'); 
        link.click();
    }
</script>

</body>
</html>
